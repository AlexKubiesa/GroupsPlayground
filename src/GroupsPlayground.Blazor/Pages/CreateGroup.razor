@page "/CreateGroup"
@using System.Text
@using GroupsPlayground.Persistence
@using GroupsPlayground.Domain
@using GroupsPlayground.Blazor.Components.CreateGroup
@inject NavigationManager navigationManager

<h1>Create new group</h1>

<div>
    <CascadingValue Value="@stepIndex">
        <WizardStep Index="0">
            <GroupProperties @ref="groupProperties"/>
        </WizardStep>
        <WizardStep Index="1">
            <GroupElements @ref="groupElements"/>
        </WizardStep>
        <WizardStep Index="2">
            <GroupOperation @ref="groupOperation"/>
        </WizardStep>
    </CascadingValue>
</div>
<div>
    <button type="button" @onclick="@OnBack">Back</button>
    <button type="button" @onclick="@OnNext">@(isLastStep ? "Finish" : "Next")</button>
</div>


@code {
    private readonly List<WizardStepContent> steps = new();
    private int stepIndex;
    private WizardStepContent step;
    private bool isLastStep;
    private GroupProperties groupProperties;
    private GroupElements groupElements;
    private GroupOperation groupOperation;

    protected override void OnAfterRender(bool firstRender)
    {
        if (!firstRender)
            return;

        steps.Add(groupProperties);
        steps.Add(groupElements);
        steps.Add(groupOperation);
        stepIndex = 0;
        UpdateStep();
    }

    public void OnBack()
    {
        if (stepIndex == 0)
        {
            Redirect();
            return;
        }

        stepIndex--;
        UpdateStep();
    }

    public async Task OnNext()
    {
        if (!step.Validate())
            return;

        if (step == groupProperties)
        {
            groupElements.GroupSize = groupProperties.Size;
        }

        if (step == groupElements)
        {
            groupOperation.Symbols = groupElements.Symbols;
        }

        if (step == groupOperation)
        {
            await DoCreateGroup();
            Redirect();
            return;
        }

        stepIndex++;
        UpdateStep();
    }

    private void Redirect() => navigationManager.NavigateTo("/");

    private void UpdateStep()
    {
        step = steps[stepIndex];
        isLastStep = (stepIndex == (steps.Count - 1));
    }

    private async Task DoCreateGroup()
    {
        using Session session = new();
        Group group = new(Guid.NewGuid(), groupProperties.Name, groupOperation.CayleyTable);
        await session.GroupRepository.AddGroupAsync(group);
        session.SaveChanges();
    }
}
